<div class="container">
  <div *ngIf="isLoading" class="loading">
    <div class="spinner"></div>
    <p>Loading Change Request...</p>
  </div>

   <div *ngIf="!isLoading && errorMessage" class="error">
    <div class="error-icon">âŒ</div>
    <h3>Error Loading Change Request</h3>
    <p>{{ errorMessage }}</p>
    <p>Redirecting to Change Requests list...</p>
    <button (click)="goBack()" class="btn-back-error">
      â† Go Back Now
    </button>
  </div>
  <div *ngIf="!isLoading && changeRequest" class="cr-view">
    <!-- Header -->
    <header class="header">
      <div class="header-content">
        <div class="header-left">
          <button (click)="goBack()" class="btn-back">
            â† Back to List
          </button>
          <h1>{{ changeRequest.crNumber }}</h1>
          <h2>{{ changeRequest.title }}</h2>
          <div class="header-meta">
            <span class="status-badge" [class]="getStatusClass(changeRequest.status)">
              {{ changeRequest.status }}
            </span>
            <span class="priority-badge" [class]="getPriorityClass(changeRequest.priority)">
              {{ changeRequest.priority }} Priority
            </span>
            <span class="meta-item">ğŸ“… {{ changeRequest.requestedDate | date:'mediumDate' }}</span>
            <span class="meta-item">ğŸ‘¤ {{ changeRequest.requestedBy }}</span>
          </div>
        </div>
        <div class="header-right">
          <div class="header-actions">
            <button (click)="exportToWord()" class="btn-action export">
              ğŸ“¥ Export to Word
            </button>
            <button *ngIf="canEdit()" (click)="editChangeRequest()" class="btn-action edit">
              âœï¸ Edit
            </button>
            <button *ngIf="canDelete()" (click)="deleteChangeRequest()" class="btn-action delete">
              ğŸ—‘ï¸ Delete
            </button>
          </div>
          <!-- site navigation removed: use shared header component -->
        </div>
      </div>
      </header>
      <div class="page-header">
        <h2>Change Request: {{ changeRequest?.title }}</h2>
        <nav class="nav-inline">
          <a class="nav-btn" routerLink="/change-requests">Back to List</a>
          <a class="nav-btn" [routerLink]="['/change-requests', changeRequest?.id, 'edit']">Edit</a>
        </nav>
      </div>

    <!-- Tabs -->
    <div class="tabs">
      <button 
        [class.active]="activeTab === 'overview'" 
        (click)="setActiveTab('overview')" 
        class="tab-btn">
        ğŸ“‹ Overview
      </button>
      <button 
        [class.active]="activeTab === 'documents'" 
        (click)="setActiveTab('documents')" 
        class="tab-btn">
        ğŸ“„ Documents
      </button>
      <button 
        [class.active]="activeTab === 'stakeholders'" 
        (click)="setActiveTab('stakeholders')" 
        class="tab-btn">
        ğŸ‘¥ Stakeholders
      </button>
      <button 
        [class.active]="activeTab === 'history'" 
        (click)="setActiveTab('history')" 
        class="tab-btn">
        ğŸ“œ History
      </button>
      <button 
        [class.active]="activeTab === 'attachments'" 
        (click)="setActiveTab('attachments')" 
        class="tab-btn">
        ğŸ“ Attachments
      </button>
      <button 
        [class.active]="activeTab === 'risk'" 
        (click)="setActiveTab('risk')" 
        class="tab-btn">
        âš ï¸ Risk Assessment
      </button>
    </div>

    <!-- Tab Content -->
    <div class="tab-content">
      
      <!-- Overview Tab -->
      <div *ngIf="activeTab === 'overview'" class="tab-pane overview">
        <div class="overview-grid">
          <div class="overview-card">
            <h3>ğŸ“ Description</h3>
            <div class="card-content">
              <p>{{ changeRequest.description }}</p>
            </div>
          </div>
          
          <div class="overview-card">
            <h3>ğŸ·ï¸ Details</h3>
            <div class="details-grid">
              <div class="detail-item">
                <span class="detail-label">Type:</span>
                <span class="detail-value">{{ changeRequest.type }}</span>
              </div>
              <div class="detail-item">
                <span class="detail-label">Release Type:</span>
                <span class="detail-value">{{ changeRequest.releaseType }}</span>
              </div>
              <div class="detail-item">
                <span class="detail-label">Target Version:</span>
                <span class="detail-value">{{ changeRequest.targetVersion || 'Not specified' }}</span>
              </div>
              <div class="detail-item">
                <span class="detail-label">Documents Required:</span>
                <span class="detail-value">{{ changeRequest.documentsRequired.length }}</span>
              </div>
              <div class="detail-item">
                <span class="detail-label">Stakeholders:</span>
                <span class="detail-value">{{ changeRequest.stakeholders.length }}</span>
              </div>
              <div class="detail-item">
                <span class="detail-label">History Entries:</span>
                <span class="detail-value">{{ changeRequest.history.length }}</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Quick Stats -->
        <div class="quick-stats">
          <div class="stat-card">
            <div class="stat-icon">ğŸ“„</div>
            <div class="stat-content">
              <h4>Documents Progress</h4>
              <div class="progress-bar">
                <div class="progress-fill" [style.width.%]="getDocumentProgress()"></div>
              </div>
              <p class="stat-text">{{ getCompletedDocuments() }}/{{ changeRequest.impactedDocuments.length }} completed</p>
            </div>
          </div>
          
          <div class="stat-card">
            <div class="stat-icon">ğŸ‘¥</div>
            <div class="stat-content">
              <h4>Stakeholder Approval</h4>
              <div class="progress-bar">
                <div class="progress-fill" [style.width.%]="getApprovalProgress()"></div>
              </div>
              <p class="stat-text">{{ getApprovedStakeholders() }}/{{ changeRequest.stakeholders.length }} approved</p>
            </div>
          </div>
        </div>

        <!-- Comments Section -->
        <div class="comments-section">
          <h3>ğŸ’¬ Comments & Discussion</h3>
          <div class="comment-input">
            <textarea 
              [(ngModel)]="newComment" 
              placeholder="Add a comment..."
              rows="3"
              class="comment-textarea">
            </textarea>
            <button (click)="addComment()" class="btn-comment">
              Add Comment
            </button>
          </div>
          
          <div class="comments-list">
            <div *ngFor="let entry of changeRequest.history.slice().reverse()" class="comment">
              <div class="comment-header">
                <span class="comment-user">{{ entry.user }}</span>
                <span class="comment-date">{{ entry.date | date:'medium' }}</span>
              </div>
              <div class="comment-action">{{ entry.action }}</div>
              <div *ngIf="entry.comments" class="comment-text">{{ entry.comments }}</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Documents Tab -->
      <div *ngIf="activeTab === 'documents'" class="tab-pane documents">
        <div class="section-header">
          <h3>ğŸ“„ Required Documents</h3>
          <span class="section-subtitle">{{ changeRequest.documentsRequired.length }} documents required for {{ changeRequest.releaseType }}</span>
        </div>
        
        <div class="documents-list">
          <div *ngFor="let doc of changeRequest.impactedDocuments" class="document-card">
            <div class="document-header">
              <h4>{{ doc.documentName }}</h4>
              <span class="doc-status" [class]="getDocumentStatusClass(doc.status)">
                {{ doc.status }}
              </span>
            </div>
            <div class="document-body">
              <p><strong>Action Required:</strong> {{ doc.action }}</p>
              <div class="document-actions">
                <button class="btn-doc-action">ğŸ“ Update Status</button>
                <button class="btn-doc-action">ğŸ“„ View Template</button>
                <button class="btn-doc-action">ğŸ“¥ Download</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Stakeholders Tab -->
      <div *ngIf="activeTab === 'stakeholders'" class="tab-pane stakeholders">
        <div class="section-header">
          <h3>ğŸ‘¥ Stakeholders & Approvers</h3>
          <span class="section-subtitle">Approval progress: {{ getApprovedStakeholders() }}/{{ changeRequest.stakeholders.length }}</span>
        </div>
        
        <div class="stakeholders-list">
          <div *ngFor="let stakeholder of changeRequest.stakeholders" class="stakeholder-card">
            <div class="stakeholder-header">
              <div class="stakeholder-info">
                <h4>{{ stakeholder.name }}</h4>
                <span class="stakeholder-role">{{ stakeholder.role }}</span>
                <span class="stakeholder-dept">{{ stakeholder.department }}</span>
              </div>
              <span class="stakeholder-status" [class]="getStakeholderStatusClass(stakeholder.status)">
                {{ stakeholder.status }}
              </span>
            </div>
            
            <div *ngIf="stakeholder.comments" class="stakeholder-comments">
              <p><strong>Comments:</strong> {{ stakeholder.comments }}</p>
            </div>
            
            <div *ngIf="stakeholder.date" class="stakeholder-date">
              <small>Updated: {{ stakeholder.date | date:'medium' }}</small>
            </div>
          </div>
        </div>

        <!-- Approval Section (if approver) -->
        <div *ngIf="isApprover() && changeRequest.status === 'Under Review'" class="approval-section">
          <h3>âœ… Approval Decision</h3>
          <div class="approval-form">
            <textarea 
              [(ngModel)]="approvalComment" 
              placeholder="Enter your approval comments..."
              rows="3"
              class="approval-textarea">
            </textarea>
            <div class="approval-buttons">
              <button (click)="approveChangeRequest()" class="btn-approve">
                âœ… Approve
              </button>
              <button (click)="rejectChangeRequest()" class="btn-reject">
                âŒ Reject
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- History Tab -->
      <div *ngIf="activeTab === 'history'" class="tab-pane history">
        <div class="section-header">
          <h3>ğŸ“œ Activity History</h3>
          <span class="section-subtitle">{{ changeRequest.history.length }} activities recorded</span>
        </div>
        
        <div class="history-timeline">
          <div *ngFor="let entry of changeRequest.history.slice().reverse()" class="timeline-item">
            <div class="timeline-date">{{ entry.date | date:'medium' }}</div>
            <div class="timeline-content">
              <div class="timeline-header">
                <span class="timeline-user">{{ entry.user }}</span>
                <span class="timeline-action">{{ entry.action }}</span>
              </div>
              <div *ngIf="entry.comments" class="timeline-comments">
                {{ entry.comments }}
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Attachments Tab -->
      <div *ngIf="activeTab === 'attachments'" class="tab-pane attachments">
        <div class="section-header">
          <h3>ğŸ“ Attachments</h3>
          <span class="section-subtitle">{{ changeRequest.attachments.length }} files attached</span>
        </div>
        
        <div class="attachments-list">
          <div *ngFor="let file of changeRequest.attachments" class="attachment-card">
            <div class="attachment-icon">
              <span *ngIf="file.type.includes('pdf')">ğŸ“•</span>
              <span *ngIf="file.type.includes('word') || file.type.includes('document')">ğŸ“˜</span>
              <span *ngIf="file.type.includes('excel') || file.type.includes('spreadsheet')">ğŸ“—</span>
              <span *ngIf="file.type.includes('image')">ğŸ–¼ï¸</span>
              <span *ngIf="!file.type.includes('pdf') && !file.type.includes('word') && !file.type.includes('excel') && !file.type.includes('image')">ğŸ“„</span>
            </div>
            <div class="attachment-info">
              <h4>{{ file.name }}</h4>
              <p class="attachment-meta">
                Size: {{ file.size }} â€¢ 
                Type: {{ file.type }} â€¢ 
                Uploaded by: {{ file.uploadedBy }} â€¢ 
                {{ file.date | date:'shortDate' }}
              </p>
            </div>
            <div class="attachment-actions">
              <button class="btn-attachment">ğŸ“¥ Download</button>
              <button class="btn-attachment">ğŸ‘ï¸ Preview</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Risk Assessment Tab -->
      <div *ngIf="activeTab === 'risk'" class="tab-pane risk">
        <div class="section-header">
          <h3>âš ï¸ Risk Assessment</h3>
          <span class="section-subtitle">Risk Level: 
            <span class="risk-level" [class]="'risk-' + changeRequest.riskAssessment.riskLevel.toLowerCase()">
              {{ changeRequest.riskAssessment.riskLevel }}
            </span>
          </span>
        </div>
        
        <div class="risk-grid">
          <div class="risk-card">
            <h4>ğŸ“Š Impact Analysis</h4>
            <div class="risk-content">
              <p>{{ changeRequest.riskAssessment.impact || 'No impact analysis provided.' }}</p>
            </div>
          </div>
          
          <div class="risk-card">
            <h4>ğŸ² Probability</h4>
            <div class="risk-content">
              <p>{{ changeRequest.riskAssessment.probability || 'No probability assessment provided.' }}</p>
            </div>
          </div>
          
          <div class="risk-card full-width">
            <h4>ğŸ›¡ï¸ Mitigation Strategy</h4>
            <div class="risk-content">
              <p>{{ changeRequest.riskAssessment.mitigation || 'No mitigation strategy provided.' }}</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Status Change Panel -->
    <div *ngIf="authService.isAdmin() || canEdit()" class="status-panel">
      <h3>ğŸ”„ Update Status</h3>
      <div class="status-form">
        <select [(ngModel)]="newStatus" class="status-select">
          <option value="Draft">Draft</option>
          <option value="Submitted">Submitted</option>
          <option value="Under Review">Under Review</option>
          <option value="Approved">Approved</option>
          <option value="Rejected">Rejected</option>
          <option value="Implemented">Implemented</option>
          <option value="Closed">Closed</option>
        </select>
        <textarea 
          [(ngModel)]="statusChangeComment" 
          placeholder="Reason for status change..."
          rows="2"
          class="status-textarea">
        </textarea>
        <button (click)="updateStatus()" class="btn-status-update">
          Update Status
        </button>
      </div>
    </div>
  </div>
</div>