<div class="cr-form-container">
  <!-- Header Section -->
  <header class="cr-header">
    <div class="brand-section">
      <div class="brand">
        <span class="brand-icon">ğŸ“‹</span>
        <span class="brand-name">DocGen</span>
      </div>
      <div class="header-content">
        <h1 class="header-title">{{ isEditMode ? 'âœï¸ Edit' : 'â• Create New' }} Change Request</h1>
        <p class="header-subtitle">
          {{ isEditMode ? 'Update existing change request' : 'Create a new change request for your release' }}
        </p>
      </div>
    </div>
    
    <div class="header-status" *ngIf="isEditMode">
      <span class="status-badge" [ngClass]="getStatusClass(changeRequest.status)">
        {{ getStatusIcon(changeRequest.status) }} {{ changeRequest.status }}
      </span>
    </div>
  </header>

  <!-- Main Content -->
  <div class="main-content">
    <!-- Form Errors -->
    <div *ngIf="formErrors.length > 0" class="error-card">
      <div class="error-header">
        <span class="error-icon">âš ï¸</span>
        <span class="error-title">Please fix the following errors:</span>
        <button class="error-close" (click)="formErrors = []">âœ•</button>
      </div>
      <ul class="error-list">
        <li *ngFor="let error of formErrors">{{ error }}</li>
      </ul>
    </div>

    <form (ngSubmit)="submitForReview()" #crForm="ngForm" class="cr-form">
      
      <!-- Basic Information Section -->
      <section class="form-section">
        <div class="section-header">
          <div class="section-title-wrapper">
            <span class="section-icon">ğŸ“‹</span>
            <h2 class="section-title">Basic Information</h2>
          </div>
          <div class="section-badge" *ngIf="changeRequest.crNumber">
            <span class="badge-label">CR Number</span>
            <span class="badge-value">{{ changeRequest.crNumber }}</span>
          </div>
        </div>
        
        <div class="form-grid">
          <!-- Title -->
          <div class="form-group full-width">
            <label for="title" class="form-label">
              <span class="label-icon">ğŸ“Œ</span>
              <span>Title <span class="required">*</span></span>
            </label>
            <div class="input-wrapper">
              <input 
                type="text" 
                id="title" 
                [(ngModel)]="changeRequest.title" 
                name="title"
                class="form-control"
                placeholder="Enter a descriptive title for this change request"
                required
                #titleField="ngModel">
            </div>
            <div *ngIf="titleField.invalid && titleField.touched" class="field-error">
              Title is required
            </div>
          </div>

          <!-- Priority -->
          <div class="form-group">
            <label for="priority" class="form-label">
              <span class="label-icon">âš ï¸</span>
              <span>Priority <span class="required">*</span></span>
            </label>
            <div class="select-wrapper">
              <select 
                id="priority" 
                [(ngModel)]="changeRequest.priority" 
                name="priority"
                class="form-control"
                required>
                <option *ngFor="let option of priorityOptions" [value]="option">
                  {{ option }}
                </option>
              </select>
              <span class="select-arrow">â–¼</span>
            </div>
          </div>

          <!-- Type -->
          <div class="form-group">
            <label for="type" class="form-label">
              <span class="label-icon">ğŸ·ï¸</span>
              <span>Type <span class="required">*</span></span>
            </label>
            <div class="select-wrapper">
              <select 
                id="type" 
                [(ngModel)]="changeRequest.type" 
                name="type"
                class="form-control"
                required>
                <option *ngFor="let option of typeOptions" [value]="option">
                  {{ option }}
                </option>
              </select>
              <span class="select-arrow">â–¼</span>
            </div>
          </div>

          <!-- Release Type -->
          <div class="form-group">
            <label for="releaseType" class="form-label">
              <span class="label-icon">ğŸ“¦</span>
              <span>Release Type <span class="required">*</span></span>
            </label>
            <div class="select-wrapper">
              <select 
                id="releaseType" 
                [(ngModel)]="changeRequest.releaseType" 
                name="releaseType"
                (change)="onReleaseTypeChange()"
                class="form-control"
                required>
                <option *ngFor="let option of releaseTypeOptions" [value]="option">
                  {{ option }}
                </option>
              </select>
              <span class="select-arrow">â–¼</span>
            </div>
          </div>

          <!-- Target Version -->
          <div class="form-group">
            <label for="targetVersion" class="form-label">
              <span class="label-icon">ğŸ”–</span>
              <span>Target Version <span class="required">*</span></span>
            </label>
            <div class="input-wrapper">
              <input 
                type="text" 
                id="targetVersion" 
                [(ngModel)]="changeRequest.targetVersion" 
                name="targetVersion"
                class="form-control"
                placeholder="e.g., v2.1.0"
                required>
            </div>
          </div>

          <!-- Description -->
          <div class="form-group full-width">
            <label for="description" class="form-label">
              <span class="label-icon">ğŸ“</span>
              <span>Description <span class="required">*</span></span>
            </label>
            <div class="textarea-wrapper">
              <textarea 
                id="description" 
                [(ngModel)]="changeRequest.description" 
                name="description"
                class="form-control textarea"
                rows="5"
                placeholder="Describe the change request in detail. Include the reason for the change, expected outcomes, and any dependencies..."
                required
                #descriptionField="ngModel"></textarea>
            </div>
            <div class="field-hint">
              {{ changeRequest.description?.length || 0 }}/500 characters
            </div>
          </div>
        </div>
      </section>

      <!-- Required Documents Section -->
      <section class="form-section">
        <div class="section-header">
          <div class="section-title-wrapper">
            <span class="section-icon">ğŸ“„</span>
            <h2 class="section-title">Required Documents</h2>
          </div>
          <div class="section-badge">
            <span class="badge-value">{{ selectedDocuments.length }}/{{ availableDocuments.length }}</span>
            <span class="badge-label">selected</span>
          </div>
        </div>
        
        <div class="section-info">
          <p class="info-text">
            <span class="info-icon">â„¹ï¸</span>
            Documents required based on <strong>{{ changeRequest.releaseType }}</strong> release type.
            Documents marked with <span class="recommended-star">â˜…</span> are recommended.
          </p>
        </div>
        
        <div class="document-controls">
          <div class="control-buttons">
            <button type="button" (click)="selectAllDocuments()" class="btn-control">
              <span class="control-icon">âœ“</span>
              <span>Select All</span>
            </button>
            <button type="button" (click)="deselectAllDocuments()" class="btn-control">
              <span class="control-icon">âœ—</span>
              <span>Deselect All</span>
            </button>
            <button type="button" (click)="selectRecommended()" class="btn-control recommended">
              <span class="control-icon">â˜…</span>
              <span>Select Recommended</span>
            </button>
          </div>
          
          <div class="document-search">
            <span class="search-icon">ğŸ”</span>
            <input 
              type="text" 
              [(ngModel)]="documentSearch" 
              name="documentSearch"
              placeholder="Search documents..."
              class="search-input"
              (input)="filterDocuments()">
            <button *ngIf="documentSearch" type="button" class="search-clear" (click)="clearDocumentSearch()">âœ•</button>
          </div>
        </div>
        
        <div class="documents-grid">
          <div *ngFor="let doc of filteredDocuments" class="document-card" [class.selected]="isDocumentSelected(doc.name)">
            <div class="document-checkbox">
              <label class="checkbox-container">
                <input 
                  type="checkbox" 
                  [checked]="isDocumentSelected(doc.name)"
                  (change)="toggleDocument(doc.name)">
                <span class="checkmark"></span>
              </label>
              
              <div class="document-content">
                <div class="document-header">
                  <span class="document-name">{{ doc.name }}</span>
                  <span *ngIf="doc.isRecommended" class="recommended-badge">â˜… Recommended</span>
                </div>
                <div class="document-meta">
                  <span class="document-type" [ngClass]="getDocumentTypeClass(doc.type)">
                    {{ doc.type }}
                  </span>
                  <span class="document-action">{{ getDocumentAction(doc.name) }}</span>
                </div>
              </div>
            </div>
            
            <div class="document-status" *ngIf="isDocumentSelected(doc.name)">
              <span class="status-indicator selected"></span>
            </div>
          </div>
        </div>
        
        <div *ngIf="filteredDocuments.length === 0" class="empty-state">
          <div class="empty-icon">ğŸ“„</div>
          <h3 class="empty-title">No Documents Found</h3>
          <p class="empty-description">
            {{ documentSearch ? 'No documents match your search.' : 'No documents are required for this release type.' }}
          </p>
          <button *ngIf="documentSearch" type="button" class="empty-action" (click)="clearDocumentSearch()">
            Clear Search
          </button>
        </div>
      </section>

      <!-- Risk Assessment Section -->
      <section class="form-section">
        <div class="section-header">
          <div class="section-title-wrapper">
            <span class="section-icon">âš ï¸</span>
            <h2 class="section-title">Risk Assessment</h2>
          </div>
        </div>
        
        <div class="form-grid">
          <!-- Risk Level -->
          <div class="form-group">
            <label for="riskLevel" class="form-label">
              <span class="label-icon">ğŸ¯</span>
              <span>Risk Level <span class="required">*</span></span>
            </label>
            <div class="select-wrapper">
              <select 
                id="riskLevel" 
                [(ngModel)]="changeRequest.riskAssessment.riskLevel" 
                name="riskLevel"
                class="form-control"
                required>
                <option value="Low">ğŸŸ¢ Low</option>
                <option value="Medium">ğŸŸ¡ Medium</option>
                <option value="High">ğŸ”´ High</option>
              </select>
              <span class="select-arrow">â–¼</span>
            </div>
          </div>

          <!-- Impact Assessment -->
          <div class="form-group full-width">
            <label for="impact" class="form-label">
              <span class="label-icon">ğŸ’¥</span>
              <span>Impact Assessment <span class="required">*</span></span>
            </label>
            <div class="textarea-wrapper">
              <textarea 
                id="impact" 
                [(ngModel)]="changeRequest.riskAssessment.impact" 
                name="impact"
                class="form-control textarea"
                rows="3"
                placeholder="Describe the potential impact of this change on systems, processes, and users..."
                required></textarea>
            </div>
          </div>

          <!-- Probability Assessment -->
          <div class="form-group full-width">
            <label for="probability" class="form-label">
              <span class="label-icon">ğŸ“Š</span>
              <span>Probability Assessment <span class="required">*</span></span>
            </label>
            <div class="textarea-wrapper">
              <textarea 
                id="probability" 
                [(ngModel)]="changeRequest.riskAssessment.probability" 
                name="probability"
                class="form-control textarea"
                rows="3"
                placeholder="Describe the likelihood of risks occurring and any contributing factors..."
                required></textarea>
            </div>
          </div>

          <!-- Mitigation Strategy -->
          <div class="form-group full-width">
            <label for="mitigation" class="form-label">
              <span class="label-icon">ğŸ›¡ï¸</span>
              <span>Mitigation Strategy <span class="required">*</span></span>
            </label>
            <div class="textarea-wrapper">
              <textarea 
                id="mitigation" 
                [(ngModel)]="changeRequest.riskAssessment.mitigation" 
                name="mitigation"
                class="form-control textarea"
                rows="3"
                placeholder="Describe how risks will be mitigated and what contingency plans are in place..."
                required></textarea>
            </div>
          </div>
        </div>
      </section>

      <!-- Stakeholders Section -->
      <section class="form-section">
        <div class="section-header">
          <div class="section-title-wrapper">
            <span class="section-icon">ğŸ‘¥</span>
            <h2 class="section-title">Stakeholders</h2>
          </div>
          <div class="section-badge">
            <span class="badge-value">{{ stakeholders.length }}</span>
            <span class="badge-label">assigned</span>
          </div>
        </div>
        
        <div class="stakeholders-grid">
          <div *ngFor="let stakeholder of stakeholders; let i = index" class="stakeholder-card">
            <div class="stakeholder-avatar">
              {{ stakeholder.name.charAt(0) }}
            </div>
            <div class="stakeholder-info">
              <h4 class="stakeholder-name">{{ stakeholder.name }}</h4>
              <span class="stakeholder-role">{{ stakeholder.role }}</span>
              <span class="stakeholder-dept">{{ stakeholder.department }}</span>
            </div>
            <div class="stakeholder-status">
              <span class="status-badge small" [ngClass]="getStakeholderStatusClass(stakeholder.status)">
                {{ stakeholder.status }}
              </span>
            </div>
            <button 
              type="button" 
              (click)="removeStakeholder(i)" 
              class="stakeholder-remove"
              *ngIf="!isEditMode"
              title="Remove stakeholder">
              âœ•
            </button>
          </div>
        </div>
        
        <div class="add-stakeholder-section">
          <h4 class="add-title">â• Add Stakeholder</h4>
          <div class="add-stakeholder-form">
            <div class="form-group small">
              <input 
                type="text" 
                [(ngModel)]="newStakeholder.name" 
                name="newStakeholderName"
                placeholder="Name"
                class="form-control">
            </div>
            <div class="form-group small">
              <input 
                type="text" 
                [(ngModel)]="newStakeholder.role" 
                name="newStakeholderRole"
                placeholder="Role (e.g., Approver, Reviewer)"
                class="form-control">
            </div>
            <div class="form-group small">
              <input 
                type="text" 
                [(ngModel)]="newStakeholder.department" 
                name="newStakeholderDept"
                placeholder="Department"
                class="form-control">
            </div>
            <button 
              type="button" 
              (click)="addStakeholder()" 
              class="btn-add"
              [disabled]="!newStakeholder.name || !newStakeholder.role">
              <span class="btn-icon">â•</span>
              <span>Add</span>
            </button>
          </div>
        </div>
      </section>

      <!-- Attachments Section -->
      <section class="form-section">
        <div class="section-header">
          <div class="section-title-wrapper">
            <span class="section-icon">ğŸ“</span>
            <h2 class="section-title">Attachments</h2>
          </div>
          <div class="section-badge" *ngIf="uploadedFiles.length > 0">
            <span class="badge-value">{{ uploadedFiles.length }}</span>
            <span class="badge-label">files</span>
          </div>
        </div>
        
        <div class="file-upload-area" (click)="fileInput.click()">
          <input 
            type="file" 
            id="fileUpload" 
            (change)="onFileSelected($event)"
            multiple
            class="file-input"
            #fileInput>
          <div class="upload-content">
            <span class="upload-icon">ğŸ“¤</span>
            <h4 class="upload-title">Click to upload files</h4>
            <p class="upload-text">or drag and drop</p>
            <p class="upload-hint">Supports PDF, Word, Excel, Images (Max 10MB each)</p>
          </div>
        </div>
        
        <div *ngIf="uploadedFiles.length > 0" class="uploaded-files">
          <h4 class="files-title">Uploaded Files</h4>
          <div class="files-list">
            <div *ngFor="let file of uploadedFiles; let i = index" class="file-card">
              <div class="file-icon">{{ getFileIcon(file.type) }}</div>
              <div class="file-info">
                <h5 class="file-name">{{ file.name }}</h5>
                <p class="file-meta">{{ file.size }} â€¢ {{ file.type || 'Unknown type' }}</p>
              </div>
              <button 
                type="button" 
                (click)="removeFile(i)" 
                class="file-remove"
                title="Remove file">
                âœ•
              </button>
            </div>
          </div>
        </div>
      </section>

      <!-- Form Actions -->
      <div class="form-actions">
        <button type="button" (click)="cancel()" class="btn-cancel">
          <span class="btn-icon">âœ•</span>
          <span>Cancel</span>
        </button>
        
        <button type="button" (click)="saveDraft()" class="btn-draft">
          <span class="btn-icon">ğŸ’¾</span>
          <span>Save as Draft</span>
        </button>
        
        <button type="submit" class="btn-submit">
          <span class="btn-icon">ğŸ“¤</span>
          <span>Submit for Review</span>
          <span class="btn-shortcut">âŒ˜S</span>
        </button>
      </div>
    </form>
  </div>

  <!-- Footer -->
  <footer class="cr-footer">
    <div class="footer-info">
      <span class="footer-icon">ğŸ‘¤</span>
      <span>Created by: {{ currentUser?.name || 'Unknown' }}</span>
      <span class="footer-separator">â€¢</span>
      <span class="footer-icon">ğŸ“…</span>
      <span>{{ changeRequest.requestedDate | date:'medium' }}</span>
    </div>
    <div class="footer-actions">
      <a routerLink="/change-requests" class="footer-link">
        <span>â†</span>
        Back to List
      </a>
    </div>
  </footer>
</div>